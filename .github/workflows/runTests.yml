name: Unit and Integration Tests

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]
    branches:
      - main
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

strategy:
  matrix:
    linux:
      imageName: 'ubuntu-latest'
    mac:
      imageName: 'macos-latest'
    windows:
      imageName: 'windows-latest'

pool:
  vmImage: $(imageName)

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '10.x'
    displayName: 'Install Node.js'
  - bash: |
      /usr/bin/Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
      echo ">>> Started xvfb"
    displayName: Start xvfb
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Linux'))
  - bash: |
      echo ">>> Compile test"
      yarn && yarn compile
      echo ">>> Compiled test"
      echo ">>> Run integration testS"
      yarn test
    displayName: Run Tests
    env:
      DISPLAY: ':99.0'
  - name: Upload Test Results
    if: always()
    uses: actions/upload-artifact@v2
    with:
      name: Test Results
      path: |
        ./junit.xml
